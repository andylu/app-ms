version: '3.2'
services:
  web:
    image: nginx:alpine
    networks:
    - gateway-web
  gateway-ms:
    build: ./ms-gateway
    depends_on:
    - log-elasticsearch
    - authorization-ms
    networks:
    - default
    - gateway-web
    - gateway-auth
    environment:
    - SPRING_PROFILES_ACTIVE=docker-compose
    ports:
    - "3001:80"
  authentication-ms:
    build: ./sample-authn
    environment:
    - SPRING_PROFILES_ACTIVE=docker-compose
    networks:
    - default
    - gateway-auth
  authorization-ms:
    build: ./sample-authz
    environment:
    - SPRING_PROFILES_ACTIVE=docker-compose
    networks:
    - gateway-auth
    - authorization
  sample-ms:
    build: ./sample-ms
    environment:
    - SPRING_PROFILES_ACTIVE=docker-compose
    deploy:
      replicas: 2
  swagger-ms:
    build: ./ms-swagger
    environment:
    - SPRING_PROFILES_ACTIVE=docker-compose
    deploy:
      replicas: 2
  security-cache:
    image: hazelcast/hazelcast:latest
    deploy:
      replicas: 2
    environment:
    - "MAX_HEAP_SIZE=512m"
    networks:
    - authorization
  cache:
    image: hazelcast/hazelcast:latest
    environment:
    - "MAX_HEAP_SIZE=512m"
    deploy:
      replicas: 4
  
  log-mongo:
    image: mongo:3
    volumes:
    - logging:/usr/share/elasticsearch/data
    networks:
    - logging
    environment:
    - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
  log-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:5.6.3
    volumes:
    - logging:/usr/share/elasticsearch/data
    networks:
    - logging
    environment:
    - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    - cluster.name=graylog
    - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
  logstash-ms:
    image: graylog/graylog:2.3.1-1
    environment:
      # CHANGE ME!
      - GRAYLOG_PASSWORD_SECRET=somepasswordpepper
      # Password: admin
      - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
      - GRAYLOG_WEB_ENDPOINT_URI=http://127.0.0.1:9000/api
    ports:
    - "9000:9000"
    depends_on:
    - log-elasticsearch
    - log-mongo
    links:
    - log-elasticsearch:elasticsearch
    - log-mongo:mongo
    networks:
    - default
    - logging

networks:
  # The default network is used for all the microservices that are not associated with anything infrastructure related.  Primarily where the aplpication specific microservices reside.
  gateway-web:
  # This network is used to facilitate the communication between the gateway and the nginx web server.
  gateway-auth:
  # This network is used to facilitate the communication between the gateway and the authn/authz microservices.
  authorization:
  # authorization-ms has it's own network to prevent other microservices from using the cache 
  logging:
  # Internal services used for logging are put into this network, but the entry point for logging is exposed.   
volumes:
  logging:
    driver: local
