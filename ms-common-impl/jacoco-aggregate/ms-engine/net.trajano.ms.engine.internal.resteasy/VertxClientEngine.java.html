<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>VertxClientEngine.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Common Microservice Implementation</a> &gt; <a href="../index.html" class="el_bundle">ms-engine</a> &gt; <a href="index.source.html" class="el_package">net.trajano.ms.engine.internal.resteasy</a> &gt; <span class="el_source">VertxClientEngine.java</span></div><h1>VertxClientEngine.java</h1><pre class="source lang-java linenums">package net.trajano.ms.engine.internal.resteasy;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.security.NoSuchAlgorithmException;

import javax.net.ssl.HostnameVerifier;
import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.SSLContext;

import org.jboss.resteasy.client.jaxrs.ClientHttpEngine;
import org.jboss.resteasy.client.jaxrs.internal.ClientInvocation;
import org.jboss.resteasy.client.jaxrs.internal.ClientResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import io.vertx.core.buffer.Buffer;
import io.vertx.core.http.HttpClient;
import io.vertx.core.http.HttpClientRequest;
import io.vertx.core.http.HttpMethod;
import io.vertx.core.http.RequestOptions;
import net.trajano.ms.engine.internal.Conversions;
import net.trajano.ms.engine.internal.VertxOutputStream;

public class VertxClientEngine implements
    ClientHttpEngine {

<span class="fc" id="L29">    private static final Logger LOG = LoggerFactory.getLogger(VertxClientEngine.class);</span>

    private final HostnameVerifier hostnameVerifier;

    private final HttpClient httpClient;

    private final SSLContext sslContext;

<span class="fc" id="L37">    public VertxClientEngine(final HttpClient httpClient) {</span>

        try {
<span class="fc" id="L40">            this.httpClient = httpClient;</span>
<span class="fc" id="L41">            sslContext = SSLContext.getDefault();</span>
<span class="fc" id="L42">            hostnameVerifier = HttpsURLConnection.getDefaultHostnameVerifier();</span>
<span class="nc" id="L43">        } catch (final NoSuchAlgorithmException e) {</span>
<span class="nc" id="L44">            throw new ExceptionInInitializerError(e);</span>
<span class="fc" id="L45">        }</span>
<span class="fc" id="L46">    }</span>

    @Override
    public void close() {

<span class="fc" id="L51">        LOG.trace(&quot;closing {}&quot;, this);</span>

<span class="fc" id="L53">    }</span>

    @Override
    public HostnameVerifier getHostnameVerifier() {

<span class="nc" id="L58">        return hostnameVerifier;</span>
    }

    @Override
    public SSLContext getSslContext() {

<span class="nc" id="L64">        return sslContext;</span>
    }

    @Override
    public ClientResponse invoke(final ClientInvocation request) {

<span class="fc" id="L70">        LOG.debug(&quot;{} {}&quot;, request.getMethod(), request.getUri());</span>
<span class="fc" id="L71">        final RequestOptions options = Conversions.toRequestOptions(request.getUri());</span>
<span class="fc" id="L72">        final HttpClientRequest httpClientRequest = httpClient.request(HttpMethod.valueOf(request.getMethod()), options);</span>

<span class="fc" id="L74">        final VertxClientResponse clientResponse = new VertxClientResponse(request.getClientConfiguration(), httpClientRequest);</span>

<span class="fc" id="L76">        LOG.debug(&quot;clientResponse={}&quot;, clientResponse);</span>
<span class="fc" id="L77">        request.getHeaders().asMap().forEach(httpClientRequest::putHeader);</span>
<span class="fc" id="L78">        httpClientRequest.setChunked(request.isChunked());</span>

<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (request.isChunked()) {</span>

<span class="nc" id="L82">            try (final VertxOutputStream os = new VertxOutputStream(httpClientRequest)) {</span>
<span class="nc" id="L83">                request.writeRequestBody(os);</span>
<span class="nc" id="L84">                LOG.trace(&quot;request body written on {}&quot;, this);</span>
<span class="nc" id="L85">                return clientResponse;</span>
<span class="nc bnc" id="L86" title="All 8 branches missed.">            } catch (final IOException e) {</span>
<span class="nc" id="L87">                throw new UncheckedIOException(e);</span>
            } finally {
<span class="nc" id="L89">                httpClientRequest.end();</span>
            }
        } else {
<span class="pc" id="L92">            try (final ByteArrayOutputStream baos = new ByteArrayOutputStream()) {</span>
<span class="fc" id="L93">                request.writeRequestBody(baos);</span>
<span class="fc" id="L94">                httpClientRequest.end(Buffer.buffer(baos.toByteArray()));</span>
<span class="fc" id="L95">                return clientResponse;</span>
<span class="pc bpc" id="L96" title="6 of 8 branches missed.">            } catch (final IOException e) {</span>
<span class="nc" id="L97">                throw new UncheckedIOException(e);</span>
            }

        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>